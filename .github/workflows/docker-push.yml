name: Docker Build, Push, Prune
run-name: ${{ github.event.inputs.branch_name || github.head_ref || github.ref_name }}

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  push:
    branches:
      - develop

  workflow_dispatch:
    inputs:
      GIT_REPO_FULL_NAME:
        description: Select RepoName
        required: false
        type: choice
        options:
          - alp-os/d2e
          - alp-os/d2e-dev-afreen
          - alp-os/d2e-dev-alicia
          - alp-os/d2e-dev-brandan
          - alp-os/d2e-dev-brian
          - alp-os/d2e-dev-hengxian
          - alp-os/d2e-dev-jerome
          - alp-os/d2e-dev-khairul
          - alp-os/d2e-dev-karthik
          - alp-os/d2e-dev-nadirah
          - alp-os/d2e-dev-nicholas
          - alp-os/d2e-dev-peter
          - alp-os/d2e-dev-qiya
          - alp-os/d2e-dev-ragavan
          - alp-os/d2e-dev-santan
          - alp-os/d2e-dev-satish
          - alp-os/d2e-dev-suwarno
      GIT_BRANCH_NAME:
        default: develop
        description: Enter BranchName / ReleaseTagName
        required: true
        type: string

concurrency:
  group: ${{ github.event.inputs.GIT_BRANCH_NAME || github.head_ref || github.ref_name }}-${{ github.event_name }}-docker-build-push-prune
  cancel-in-progress: true

env:
  GIT_BRANCH_NAME: ${{ github.event.inputs.GIT_BRANCH_NAME || github.head_ref || github.ref_name }}
  GIT_REPO_FULL_NAME: ${{ github.event.inputs.git_repo_full_name || github.event.pull_request.head.repo.full_name || github.event.repository.full_name }} # workflow_dispatch || pull_request || push

jobs:
  bld:
    strategy:
      # fail-fast: false
      matrix:
        include:
          - name: alp-data-node/alp-fhir-server-post-init
            directory: ./services/alp-fhir
            context: .
            fileName: Dockerfile.client
    uses: ./.github/workflows/docker-push-called.yml
    with:
      AZ_REGISTRY_REPOSITORY: alp-data-node/alp-fhir-server-post-init # ${{ matrix.name }}
      # DOCKER_BUILD_CONTEXT_PATH: ${{ matrix.context }}
      DOCKER_BUILD_FILE_PATH: ./services/alp-fhir/Dockerfile.client # ${{ matrix.directory }}/${{ matrix.fileName }}
      # DOCKER_BUILD_PULL_BOOL: ${{ matrix.pull || false }}
      # DOCKER_IMG_PUSH_BOOL: ${{ needs.setup.outputs.DOCKER_IMG_PUSH_BOOL }}
      DOCKER_IMG_TAG_NAME: 189_docker-build-push-prune3 # ${{ needs.setup.outputs.DOCKER_IMG_TAG_NAME }}
      GIT_BRANCH_NAME: 189_docker-build-push-prune3 # ${{ needs.setup.outputs.GIT_BRANCH_NAME }}
      GIT_COMMIT_ID__PLUGINS_REPO: alp-os/d2e-dev-brian # ${{ matrix.GIT_COMMIT_ID__PLUGINS_REPO }}
      GIT_REPO_FULL_NAME: alp-os/d2e-dev-brian # ${{ needs.setup.outputs.GIT_REPO_FULL_NAME }}
    secrets: inherit
