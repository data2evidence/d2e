{{- if not .Values.hub.existingSecret }}
kind: Secret
apiVersion: v1
metadata:
  name: hub-secret
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
type: Opaque
data:
  auth.client-secret: {{ .Values.auth.clientSecret | b64enc | quote }}
  proxy.token: {{ (required "Proxy token must be a 32 byte random string generated with `openssl rand -hex 32`!" .Values.proxy.secretToken) | b64enc | quote }}
  {{- if .Values.hub.cookieSecret }}
  hub.cookie-secret: {{ .Values.hub.cookieSecret | b64enc | quote }}
  {{- end }}
  {{- if .Values.hub.db.password }}
  hub.db.password: {{ .Values.hub.db.password | b64enc | quote }}
  {{- end }}
  {{- if .Values.hub.db.url }}
  hub.db.url: {{ .Values.hub.db.url | b64enc | quote }}
  {{- end }}
  {{- if .Values.auth.state.enabled }}
  auth.state.crypto-key: {{ (required "Encryption key is required for auth state to be persisted!" .Values.auth.state.cryptoKey) | b64enc | quote }}
  {{- end }}
  {{- $values := dict "hub" dict }}
  {{- /* pluck only needed secret values, preserving values.yaml structure */ -}}
  {{- $_ := set $values "auth" dict }}
  {{- range $key, $auth := .Values.auth }}
    {{- if typeIs "map[string]interface {}" $auth }}
      {{- if (or $auth.clientSecret $auth.password) }}
        {{- $_ := set $values.auth $key (pick $auth "clientSecret" "password") }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- $_ := set $values.hub "services" dict }}
  {{- range $key, $service := .Values.hub.services }}
    {{- if $service.apiToken }}
      {{- $_ := set $values.hub.services $key (pick $service "apiToken") }}
    {{- end }}
  {{- end }}
  values.yaml: {{ $values | toYaml | b64enc | quote }}
{{- end }}
---
kind: Secret
apiVersion: v1
metadata:
  name: tls-secrets
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
type: Opaque
data:
  JHUB_CA_CERT: "{{ .Values.tls.JHUB_CA_CERT | b64enc }}"
  JHUB_CA_CERT_TRUST: "{{ .Values.tls.JHUB_CA_CERT_TRUST | b64enc }}"
  JHUB_CA_KEY: "{{ .Values.tls.JHUB_CA_KEY | b64enc }}"
  JHUB_CLIENT_CA_CERT: "{{ .Values.tls.JHUB_CLIENT_CA_CERT | b64enc }}"
  JHUB_CLIENT_CA_KEY: "{{ .Values.tls.JHUB_CLIENT_CA_KEY | b64enc }}"
  JHUB_CLIENT_CERT: "{{ .Values.tls.JHUB_CLIENT_CERT | b64enc }}"
  JHUB_CLIENT_KEY: "{{ .Values.tls.JHUB_CLIENT_KEY | b64enc }}"
  JHUB_AZURE_CA_CERT_TRUST: "{{ .Values.tls.JHUB_AZURE_CA_CERT_TRUST | b64enc }}"
  JHUB_MRI_APP_ROUTER_CA_ROOT_CERT: "{{ .Values.tls.JHUB_MRI_APP_ROUTER_CA_ROOT_CERT | b64enc }}"
---
kind: Secret
apiVersion: v1
metadata:
  name: swift-secrets
  labels:
    {{- include "jupyterhub.labels" . | nindent 4 }}
type: Opaque
data:
  url: "{{ .Values.SWIFT.OAUTH_URL | b64enc }}"
  password: "{{ .Values.SWIFT.PASSWORD | b64enc }}"
  tenant: "{{ .Values.SWIFT.TENANT | b64enc }}"
  user: "{{ .Values.SWIFT.USERNAME | b64enc }}"
  remote_alias: "{{ .Values.SWIFT.REMOTE_ALIAS | b64enc }}"
  container: "{{ .Values.SWIFT.CONTAINER | b64enc }}"