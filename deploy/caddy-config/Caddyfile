{
	debug
	pki {
		ca local {
			name "ALP Local CA"
			root_cn "ALP Local CA - 2024 ECC Root"
			intermediate_cn "ALP Local CA - ECC Intermediate"
		}
		ca alp-internal {
			name "ALP Internal CA"
			root_cn "ALP Internal CA - 2024 ECC Root"
			intermediate_cn "ALP Internal CA - ECC Intermediate"
		}
	}
}

https://*.alp.local:55555 {
	tls {
		issuer internal {
			ca alp-internal
			lifetime 360d
			sign_with_root
		}
	}
	respond alp-internal
}

(forward_authentication) {
	# Enable this for using perseus user service
	# forward_auth http://alp-perseus-user-1:5001 {
	# 	uri /user/api/is_token_valid_internal
	# 	copy_headers Username
	# }

	# Enable this for using D2E user-mgmt service
	forward_auth https://trex:33000 {
		transport http {
			tls
			tls_insecure_skip_verify
			read_buffer 8192
		}
		uri /usermgmt/api/me/is_token_valid_internal
		copy_headers Username
	}
}

(cors) {
	@cors_preflight method OPTIONS

	@cors_origin {
		header_regexp Origin ^https?://localhost:(4000|5173|8081|4800|4900)?$
	}

	header @cors_origin {
		Access-Control-Allow-Origin "{http.request.header.Origin}"
		Vary Origin
		Access-Control-Allow-Headers "*"
		Access-Control-Allow-Credentials "true"
		defer
	}

	handle @cors_preflight {
		header {
			Access-Control-Allow-Origin "{http.request.header.Origin}"
			Access-Control-Allow-Credentials true
			Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
			Access-Control-Max-Age "3600"
			Vary Origin
			defer
		}
		respond "" 204
	}
}

(perseus) {
	log {
		format console {
			level_format color
		}
	}

	handle /backend/* {
		import forward_authentication
		reverse_proxy http://alp-perseus-backend-1:5004 {
			header_up X-Real-IP {http.request.remote_host}
		}
	}

	handle /white-rabbit/* {
		import forward_authentication
		reverse_proxy http://alp-perseus-white-rabbit-1:8000 {
			header_up X-Real-IP {http.request.remote_host}
		}
	}

	handle /cdm-builder/* {
		import forward_authentication
		reverse_proxy http://alp-perseus-cdm-builder-1:9000 {
			header_up X-Real-IP {http.request.remote_host}
		}
	}

	handle /files-manager/* {
		import forward_authentication
		reverse_proxy http://files-manager:10500 {
			header_up X-Real-IP {http.request.remote_host}
		}
	}
}

(portal) {
	log {
		format console {
			level_format color
		}
	}

	# Logto api server
	@logto {
		path /index.*
		path /api/*
		path /oidc/*
		path /sign-in
		path /consent
		path /callback/* # For azure connector
	}

	handle @logto {
		reverse_proxy http://alp-logto-1:3001 {
			header_up Host {upstream_hostport}
			transport http {
				read_buffer 8192
			}
		}
	}


	handle_path /portal/env.js {
			rewrite * /portal/env.js
			reverse_proxy https://trex:33000 {
				transport http {
					tls
					tls_insecure_skip_verify
					read_buffer 8192
				}
			}
		}
		handle /portal/static/css/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		handle /portal/static/js/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		handle /portal/static/media/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

	handle /portal/docs/* {
		reverse_proxy https://trex:33000 {
			transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
		}
	}

	handle_path /mapping/* {
		root * /home/docker/ui-files/mapping/
		encode zstd gzip
		file_server {
			precompressed zstd br gzip
		}
	}

		handle /portal/icons/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		handle /portal/assets/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		handle /portal/translations/* {
			reverse_proxy https://trex:33000 {
				transport http {
										tls
					tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		

		handle /portal/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}

		handle /portal {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
			}
		}
		
	

	handle /flow/* {
		reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
			}
	}

	handle /analysis/* {
		reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
			}
	handle_path /jobs/* {
		root * /home/docker/ui-files/jobs/
		encode zstd gzip
		file_server {
			precompressed zstd br gzip
		}
	}

	handle /mapping/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
			}
	}

	handle /log-viewer/* {
		reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /starboard-jupyter/* {
			reverse_proxy https://trex:33000 {
				transport http {
					
					read_buffer 8192
				}
			}
	}

	handle /starboard-notebook-base/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /mri/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/core/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/config/global/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/mri/pa/config/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/mri/pa/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/genomics/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/mri/pa/config/i18n/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /ui/core/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /ui/m/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/patient/app/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/cdw/config/i18n/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/cdw/config/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/patient/config/ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/patient/shared/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /hc/hph/patient/config/i18n/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	handle /ui/* {
			reverse_proxy https://trex:33000 {
				transport http {
				tls
				tls_insecure_skip_verify
					
					read_buffer 8192
				}
			}
	}

	# handle /oauth/* {
	#	reverse_proxy https://alp-minerva-gateway-1:41100 {
	#		transport http {
	#			tls
	#			tls_insecure_skip_verify
	#			read_buffer 8192
	#		}
	#	}
	# }

	## call gateway if there are no matched files
	handle {
		reverse_proxy https://trex:33000 {
			transport http {
				tls
				tls_insecure_skip_verify
				read_buffer 8192
			}
		}
	}
}

https://localhost:41101 {
	tls internal
	respond ""
}

https://{$CADDY__ALP__PUBLIC_FQDN} {
	{$TLS__CADDY_DIRECTIVE} 
	{$CADDY__CORS_LOCAL_UI}
	import perseus
	import portal
}

https://{$CADDY__FHIR_SERVER__PUBLIC_FQDN:localhost}:41130 {
	log {
		format console {
			level_format color
		}
	}

	tls internal
	handle /* {
		reverse_proxy http://alp-minerva-fhir-fe-server-1:3000 {
			header_up Host {$CADDY__FHIR_SERVER__PUBLIC_FQDN}:3000
			transport http {
				read_buffer 8192
			}
		}
	}
}
